<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SiRekon BPHTB | Sistem Rekonsiliasi</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-white min-h-screen p-4">

    <!-- Toast message untuk notifikasi -->
    <div id="toast"
        class="fixed bottom-5 right-5 bg-green-500 text-white px-4 py-2 rounded-xl shadow-lg opacity-0 transition-opacity duration-300 z-50">
    </div>

    <div class="flex flex-col md:flex-row w-full min-h-screen bg-white rounded-2xl shadow-xl">
        <!-- Sidebar -->
        <aside
            class="w-full md:w-1/4 max-w-full md:max-w-xs bg-white shadow-lg p-6 flex flex-col gap-6 border-b md:border-b-0 md:border-r border-gray-200 rounded-t-2xl md:rounded-l-2xl md:rounded-tr-none">
            <div class="flex items-center gap-3 mb-2 justify-center">
                <i class="bi bi-files text-blue-700 text-2xl"></i>
                <h2 class="text-xl font-bold text-gray-700">Sistem Rekonsiliasi</h2>
            </div>

            <div class="flex flex-col gap-2 text-sm text-gray-600 p-3 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex justify-between items-center">
                    <span>Data Monitoring:</span>
                    <span id="totalMonitoring" class="font-bold text-gray-800">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span>Data Ke-2:</span>
                    <span id="totalData2" class="font-bold text-gray-800">0</span>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <!-- Upload File Monitoring -->
                <div>
                    <label for="fileMonitoring" class="block w-full cursor-pointer">
                        <span id="uploadLabelMonitoring"
                            class="w-full flex justify-center items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg shadow-md transition">
                            <i class="bi bi-upload"></i>
                            <span class="truncate">Upload File Monitoring</span>
                        </span>
                    </label>
                    <input type="file" id="fileMonitoring" accept=".xlsx, .xls, .csv" class="hidden" />
                </div>
                <!-- Upload File Data Ke-2 -->
                <div>
                    <label for="fileData2" class="block w-full cursor-pointer">
                        <span id="uploadLabelData2"
                            class="w-full flex justify-center items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg shadow-md transition">
                            <i class="bi bi-upload"></i>
                            <span class="truncate">Upload File Data Ke-2</span>
                        </span>
                    </label>
                    <input type="file" id="fileData2" accept=".xlsx, .xls, .csv" class="hidden" />
                </div>
                <!-- Filter Tanggal -->
                <div class="flex items-center gap-2">
                    <i class="bi bi-calendar-date text-lg text-gray-800"></i>
                    <select id="tglSelect"
                        class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" disabled>
                        <option value="">Pilih Tanggal</option>
                    </select>
                </div>
                <!-- Filter Tipe Transaksi -->
                <div class="flex items-center gap-2">
                    <i class="bi bi-clock text-lg text-gray-800"></i>
                    <select id="waktuSelect"
                        class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" disabled>
                        <option value="semua">SEMUA TRANSAKSI</option>
                        <option value="kurang">AKHIR PEMBAYARAN</option>
                        <option value="lebih">TGL PELIMPAHAN</option>
                    </select>
                </div>

                <!-- Filter Keterangan (baru) -->
                <div class="flex items-start gap-2">
                    <i class="bi bi-file-earmark-text text-lg text-gray-800 mt-1"></i>
                    <div class="w-full">
                        <div class="flex gap-2 mb-2 text-sm">
                            <label class="inline-flex items-center gap-2">
                                <input type="radio" name="keteranganMode" id="ketModeDetail" value="detail" checked>
                                <span>Detail</span>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="radio" name="keteranganMode" id="ketModeRingkas" value="ringkas">
                                <span>Ringkas</span>
                            </label>
                        </div>
                        <select id="keteranganSelect"
                            class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" disabled>
                            <option value="">-- Semua Keterangan --</option>
                        </select>
                    </div>
                </div>
                <!-- Tombol Reset -->
                <button id="btnReset"
                    class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-600 transition w-full flex items-center justify-center gap-2"
                    disabled>
                    <i class="bi bi-arrow-repeat text-lg"></i>
                    Reset Filter
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="w-full md:w-3/4 px-4 md:px-8 py-6">
            <div id="summaryCards" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-blue-50 p-6 rounded-2xl shadow-md">
                    <p class="text-sm font-medium text-blue-700 mb-2">Total Pembayaran</p>
                    <p id="totalPembayaran" class="text-2xl font-bold text-blue-900">0</p>
                </div>
                <div class="bg-yellow-50 p-6 rounded-2xl shadow-md">
                    <p class="text-sm font-medium text-yellow-700 mb-2">Total Denda</p>
                    <p id="totalDenda" class="text-2xl font-bold text-yellow-900">0</p>
                </div>
                <div class="bg-green-50 p-6 rounded-2xl shadow-md">
                    <p class="text-sm font-medium text-green-700 mb-2">Total Mutasi Kredit</p>
                    <p id="totalMutasi" class="text-2xl font-bold text-green-900">0</p>
                </div>
            </div>

            <div id="hasilGabungan" class="border rounded-2xl p-4 bg-white shadow-lg">
                <p class="text-center text-gray-500 py-10">Silakan unggah kedua file untuk melihat hasil gabungannya.
                </p>
            </div>
        </main>
    </div>

    <script>
        let dataMonitoringList = [];
        let dataKeduaList = [];
        let fullCombinedData = []; // Menyimpan data gabungan asli

        // --- FUNGSI EVENT LISTENER ---
        document.getElementById("fileMonitoring").addEventListener("change", function (e) {
            processFile(e.target.files[0], this.previousElementSibling.querySelector('span'), (result) => {
                // PERUBAHAN: Langsung urutkan data tanggal Z-A
                dataMonitoringList = result.sort((a, b) => b.localeCompare(a));
                document.getElementById("totalMonitoring").textContent = dataMonitoringList.length.toLocaleString('id-ID');
                combineAndRenderData();
            });
        });

        document.getElementById("fileData2").addEventListener("change", function (e) {
            processFile(e.target.files[0], this.previousElementSibling.querySelector('span'), (result) => {
                dataKeduaList = result;
                document.getElementById("totalData2").textContent = dataKeduaList.length.toLocaleString('id-ID');
                combineAndRenderData();
            });
        });

        document.getElementById("tglSelect").addEventListener("change", applyFilters);
        document.getElementById("waktuSelect").addEventListener("change", applyFilters);
        document.getElementById("keteranganSelect").addEventListener("change", applyFilters);
        // mode radio listeners untuk rebuild opsi & filter saat berubah
        document.querySelectorAll('input[name="keteranganMode"]').forEach(r => {
            r.addEventListener('change', () => {
                populateKeteranganFilter(fullCombinedData || []);
                applyFilters();
            });
        });

        document.getElementById("btnReset").addEventListener("click", function () {
            document.getElementById("tglSelect").value = "";
            document.getElementById("waktuSelect").value = "semua";
            document.getElementById("keteranganSelect").value = "";
            applyFilters();
        });

        // --- FUNGSI PEMROSESAN FILE GENERIK ---
        function processFile(file, labelElement, callback) {
            const uploadIcon = `<i class="bi bi-upload"></i>`;
            const fileIcon = `<i class="bi bi-file-earmark-excel"></i>`;
            const loadingSpinner = `<div class="spinner"></div>`;
            const originalLabel = labelElement.innerHTML;

            if (!file) { labelElement.innerHTML = originalLabel; return; }

            labelElement.innerHTML = `${loadingSpinner}<span class="truncate">Memproses...</span>`;

            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];

                    let resultData;

                    // PERUBAHAN: Logika Sederhana untuk file monitoring
                    if (labelElement.id === 'uploadLabelMonitoring') {
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null, raw: true });
                        const sanitizedJsonData = jsonData.map(row => {
                            const newRow = {};
                            for (const key in row) { if (Object.prototype.hasOwnProperty.call(row, key)) newRow[key.trim()] = row[key]; }
                            return newRow;
                        });
                        resultData = sanitizedJsonData
                            .map(row => excelSerialToDateTimeString(row['Tanggal Pembayaran']))
                            .filter(val => val);

                        // PERUBAHAN: File ke-2 mengambil semua kolom yang diperlukan
                    } else if (labelElement.id === 'uploadLabelData2') {
                        const rowsAsArray = XLSX.utils.sheet_to_json(worksheet, { defval: null, header: 1 });
                        let headerRowIndex = -1, headerRow = [];
                        for (let i = 0; i < Math.min(rowsAsArray.length, 10); i++) {
                            const row = rowsAsArray[i];
                            if (row && row.map(h => String(h || '').trim()).includes('NO') && row.map(h => String(h || '').trim()).includes('NAMA WP')) {
                                headerRowIndex = i;
                                headerRow = row.map(h => String(h || '').trim());
                                break;
                            }
                        }

                        if (headerRowIndex === -1) throw new Error("Header (NO, NAMA WP) tidak ditemukan.");

                        const colIndices = { no: headerRow.indexOf('NO'), nama: headerRow.indexOf('NAMA WP'), pembayaran: headerRow.indexOf('PEMBAYARAN'), denda: headerRow.indexOf('DENDA'), ket: headerRow.indexOf('KET') };
                        const dataRows = rowsAsArray.slice(headerRowIndex + 1);
                        resultData = dataRows
                            .map(row => ({
                                'No': row[colIndices.no],
                                'Nama': row[colIndices.nama],
                                'Pembayaran': row[colIndices.pembayaran],
                                'Denda': row[colIndices.denda],
                                'Keterangan': row[colIndices.ket]
                            }))
                            .filter(row => row.No != null && String(row.No).trim() !== "");
                    }

                    labelElement.innerHTML = `${fileIcon}<span class="truncate">${file.name}</span>`;
                    showToast(`File "${file.name}" berhasil diproses.`, false);
                    callback(resultData);

                } catch (error) {
                    console.error("Gagal membaca file Excel:", error);
                    labelElement.innerHTML = originalLabel;
                    showToast(error.message || "Gagal memuat file.", true);
                }
            };
            reader.onerror = function (error) { labelElement.innerHTML = originalLabel; showToast("Terjadi kesalahan fundamental saat membaca file.", true); };
            reader.readAsArrayBuffer(file);
        }

        function excelSerialToDateTimeString(serial) {
            if (typeof serial !== 'number' || serial <= 1) return null;
            const days = Math.floor(serial - 25569);
            const date = new Date(days * 86400 * 1000);
            const fractionalDay = serial - Math.floor(serial);
            const totalSeconds = Math.floor((fractionalDay * 86400) + 0.5);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            const datePart = `${date.getUTCFullYear()}-${pad(date.getUTCMonth() + 1)}-${pad(date.getUTCDate())}`;
            const timePart = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            return `${datePart} ${timePart}`;
        }

        // PERUBAHAN: Logika penggabungan baru
        function combineAndRenderData() {
            if (dataMonitoringList.length === 0 || dataKeduaList.length === 0) return;

            fullCombinedData = dataKeduaList.map((data2Row, index) => {
                return {
                    ...data2Row,
                    TanggalPembayaran: dataMonitoringList[index] || ''
                };
            });

            populateDateFilter(fullCombinedData);
            populateKeteranganFilter(fullCombinedData);
            applyFilters();

            document.getElementById('tglSelect').disabled = false;
            document.getElementById('waktuSelect').disabled = false;
            document.getElementById('keteranganSelect').disabled = false;
            document.getElementById('btnReset').disabled = false;
        }

        function applyFilters() {
            const selectedDate = document.getElementById("tglSelect").value;
            const selectedTime = document.getElementById("waktuSelect").value;
            const selectedKeterangan = document.getElementById("keteranganSelect")?.value || "";
            const mode = document.querySelector('input[name="keteranganMode"]:checked')?.value || 'detail';

            let filteredData = fullCombinedData;

            if (selectedDate) {
                filteredData = filteredData.filter(row => (row.TanggalPembayaran || '').startsWith(selectedDate));
            }

            if (selectedTime !== 'semua') {
                filteredData = filteredData.filter(row => {
                    const timePart = (row.TanggalPembayaran || '').split(' ')[1];
                    if (!timePart) return false;
                    return selectedTime === 'kurang' ? timePart < '17:00:00' : timePart >= '17:00:00';
                });
            }

            if (mode === 'detail') {
                if (selectedKeterangan) {
                    filteredData = filteredData.filter(row => {
                        const k = (row.Keterangan || "").toString().trim();
                        return k === selectedKeterangan;
                    });
                }
            } else {
                // Ringkas: dua pilihan. Jika kosong -> semua.
                if (selectedKeterangan === 'BPHTB-Pemberian Hak Baru') {
                    filteredData = filteredData.filter(row => isPemberianHakBaru(row.Keterangan));
                } else if (selectedKeterangan === 'BPHTB-Pemindahan Hak') {
                    filteredData = filteredData.filter(row => !isPemberianHakBaru(row.Keterangan));
                }
            }

            updateSummaryCards(filteredData);
            renderHasilGabungan(filteredData);
        }

        function populateDateFilter(data) {
            const tglSelect = document.getElementById('tglSelect');
            tglSelect.innerHTML = '<option value="">Tampilkan Semua</option>';
            const dateCounts = data.reduce((acc, row) => {
                if (row.TanggalPembayaran) {
                    const datePart = row.TanggalPembayaran.split(' ')[0];
                    acc[datePart] = (acc[datePart] || 0) + 1;
                }
                return acc;
            }, {});
            // Urutkan tanggal Z-A di dropdown
            const sortedDates = Object.keys(dateCounts).sort((a, b) => b.localeCompare(a));
            for (const date of sortedDates) {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = `${date} (${dateCounts[date]} data)`;
                tglSelect.appendChild(option);
            }
        }

        function populateKeteranganFilter(data) {
            const sel = document.getElementById('keteranganSelect');
            if (!sel) return;
            const prev = sel.value;
            sel.innerHTML = '<option value="">-- Semua Keterangan --</option>';
            const mode = document.querySelector('input[name="keteranganMode"]:checked')?.value || 'detail';

            if (mode === 'ringkas') {
                const opt1 = document.createElement('option');
                opt1.value = 'BPHTB-Pemberian Hak Baru';
                opt1.textContent = 'BPHTB-Pemberian Hak Baru';
                sel.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = 'BPHTB-Pemindahan Hak';
                opt2.textContent = 'BPHTB-Pemindahan Hak';
                sel.appendChild(opt2);
            } else {
                const set = new Set();
                data.forEach(r => {
                    let k = r.Keterangan;
                    if (k === null || k === undefined) return;
                    k = String(k).trim();
                    if (k !== '') set.add(k);
                });
                Array.from(set).sort().forEach(k => {
                    const opt = document.createElement('option');
                    opt.value = k;
                    opt.textContent = k;
                    sel.appendChild(opt);
                });
            }

            if (prev) {
                const exists = Array.from(sel.options).some(o => o.value === prev);
                sel.value = exists ? prev : '';
            }
        }

        // helper: deteksi 'pemberian hak baru diluar pelepasan hak' (exact match, case-insensitive)
        function isPemberianHakBaru(keterangan) {
            if (!keterangan) return false;
            const s = String(keterangan).trim().toLowerCase();
            return s === 'pemberian hak baru diluar pelepasan hak';
        }

        function updateSummaryCards(data) {
            let totalPembayaran = 0, totalDenda = 0;
            data.forEach(row => {
                totalPembayaran += parseFloat(row.Pembayaran) || 0;
                totalDenda += parseFloat(row.Denda) || 0;
            });
            const totalMutasi = totalPembayaran + totalDenda;
            document.getElementById('totalPembayaran').textContent = totalPembayaran.toLocaleString('id-ID');
            document.getElementById('totalDenda').textContent = totalDenda.toLocaleString('id-ID');
            document.getElementById('totalMutasi').textContent = totalMutasi.toLocaleString('id-ID');
        }

        function renderHasilGabungan(dataList) {
            const container = document.getElementById("hasilGabungan");
            if (dataList.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-10">Tidak ada data yang cocok dengan filter Anda.</p>`;
                return;
            }

            let tableHTML = `<h3 class="text-lg font-semibold text-gray-800 mb-2">Data Gabungan (${dataList.length} baris)</h3>
                            <div class="overflow-auto max-h-[70vh] border border-gray-200 rounded-lg">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="p-3">No</th>
                                        <th class="p-3">Nama Wajib Pajak</th>
                                        <th class="p-3 text-right">Pembayaran</th>
                                        <th class="p-3 text-right">Denda</th>
                                        <th class="p-3">Keterangan</th>
                                        <th class="p-3">Tanggal Pembayaran</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">`;

            dataList.forEach((row) => {
                const pembayaran = typeof row.Pembayaran === 'number' ? row.Pembayaran.toLocaleString('id-ID') : (row.Pembayaran || 0);
                const denda = typeof row.Denda === 'number' ? row.Denda.toLocaleString('id-ID') : (row.Denda || 0);
                tableHTML += `<tr class="hover:bg-gray-50">
                                <td class="p-3">${row.No || ''}</td>
                                <td class="p-3">${row.Nama || ''}</td>
                                <td class="p-3 text-right font-mono">${pembayaran}</td>
                                <td class="p-3 text-right font-mono">${denda}</td>
                                <td class="p-3">${row.Keterangan || ''}</td>
                                <td class="p-3 font-mono">${row.TanggalPembayaran}</td>
                              </tr>`;
            });

            tableHTML += `</tbody></table></div>`;
            container.innerHTML = tableHTML;
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 px-4 py-2 rounded-xl shadow-lg opacity-100 transition-opacity duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`;
            setTimeout(() => { toast.style.opacity = "0"; }, 3000);
        }

    </script>
</body>

</html>