<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SiRekon PBB | Sistem Rekonsiliasi PBB</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .toast-enter-active,
        .toast-leave-active {
            transition: opacity 0.5s ease;
        }

        .toast-enter-from,
        .toast-leave-to {
            opacity: 0;
        }

        /* Styling untuk loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-white min-h-screen p-4">

    <!-- Toast message untuk notifikasi -->
    <div id="toast"
        class="fixed bottom-5 right-5 bg-green-500 text-white px-4 py-2 rounded-xl shadow-lg opacity-0 transition-opacity duration-300 z-50">
    </div>

    <!-- Kontainer utama tanpa batasan lebar, mengisi penuh layar -->
    <div class="flex flex-col md:flex-row w-full min-h-screen bg-white rounded-2xl shadow-xl">
        <!-- Sidebar -->
        <aside
            class="w-full md:w-1/4 max-w-full md:max-w-xs bg-white shadow-lg p-6 flex flex-col gap-4 border-b md:border-b-0 md:border-r border-gray-200 rounded-t-2xl md:rounded-l-2xl md:rounded-tr-none mx-auto md:mx-0">
            <div class="flex items-center gap-3 mb-2 justify-center">
                <i class="bi bi-bank2 text-blue-700 text-2xl"></i>
                <h2 class="text-xl font-bold text-gray-700">Sistem Rekonsiliasi PBB</h2>
            </div>

            <!-- Upload Excel -->
            <div class="mb-2">
                <label for="fileExcel" class="block w-full cursor-pointer">
                    <span id="uploadLabel"
                        class="w-full flex justify-center items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-400 transition overflow-hidden whitespace-nowrap"
                        style="text-align:center;">
                        <i class="bi bi-upload"></i>
                        <span class="truncate max-w-full">
                            Upload File Excel PBB
                        </span>
                    </span>
                </label>
                <input type="file" id="fileExcel" accept=".xlsx, .xls" class="hidden" />
            </div>
            <!-- Dropdown Filters -->
            <div class="flex flex-col gap-4">
                <div class="flex space-x-2 items-center">
                    <input id="inputTeks" type="text" placeholder="Tempelkan Keterangan Disini"
                        class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition"
                        spellcheck="false" />
                    <button type="button" onclick="pasteFromClipboard()"
                        class="flex items-center gap-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg shadow-md transition"
                        title="Paste"><i class="bi bi-clipboard"></i></button>
                </div>
                <div class="flex items-center gap-2">
                    <i class="bi bi-bank text-lg text-gray-800"></i>
                    <select id="bankSelect"
                        class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" disabled>
                        <option value="">Pilih Kategori Bank</option>
                        <option value="PBBU">PBBU</option>
                        <option value="PBBQRIS">PBBQRIS</option>
                        <option value="PBBVA">PBBVA</option>
                        <option value="PBBKOLEKTIF">PBBKOLEKTIF</option>
                        <option value="EPBB">EPBB</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <i class="bi bi-calendar-date text-lg text-gray-800"></i>
                    <select id="tglSelect"
                        class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" disabled>
                        <option value="">Pilih Tanggal Pembayaran</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <i class="bi bi-clock text-lg text-gray-800"></i>
                    <select id="waktuSelect"
                        class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" disabled>
                        <option value="semua">SEMUA TRANSAKSI</option>
                        <option value="kurang">AKHIR PEMBAYARAN</option>
                        <option value="lebih">TGL PELIMPAHAN</option>
                    </select>
                </div>

                <button id="btnReset"
                    class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-600 transition w-full flex items-center justify-center gap-2">
                    <i class="bi bi-arrow-repeat text-lg"></i>
                    Reset Filter
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="w-full md:w3/4 px-4 md:px-8 py-6">
            <div id="summaryCards" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-blue-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
                    <p class="text-sm font-medium text-blue-700 mb-2">Total PBBP2</p>
                    <div class="flex items-center justify-between">
                        <p id="totalPbbText" class="text-2xl font-bold text-blue-900">0</p>
                        <button onclick="copyToClipboard(document.getElementById('totalPbbText')?.textContent || '0')"
                            class="ml-3 text-blue-500 hover:text-blue-700">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                <div class="bg-yellow-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
                    <p class="text-sm font-medium text-yellow-700 mb-2">Pendapatan Denda PBBP2</p>
                    <div class="flex items-center justify-between">
                        <p id="dendaText" class="text-2xl font-bold text-yellow-900">0</p>
                        <button onclick="copyToClipboard(document.getElementById('dendaText')?.textContent || '0')"
                            class="ml-3 text-yellow-500 hover:text-yellow-700">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                <div class="bg-green-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
                    <p class="text-sm font-medium text-green-700 mb-2">Total Mutasi Kredit</p>
                    <div class="flex items-center justify-between">
                        <p id="mutasiText" class="text-2xl font-bold text-green-900">0</p>
                        <button onclick="copyToClipboard(document.getElementById('mutasiText')?.textContent || '0')"
                            class="ml-3 text-green-500 hover:text-green-700">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="border rounded-2xl px-4 py-4 bg-white shadow-lg">
                <div id="fiturGroup" class="flex flex-col md:flex-row gap-2 md:gap-4 text-sm items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-600 font-semibold">Mode:</span>
                        <div class="flex flex-row gap-4" id="fiturRadioGroup">
                            <label class="flex items-center gap-1">
                                <input type="radio" name="fitur" value="versi2" checked disabled />
                                Tambah
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="radio" name="fitur" value="versi1" disabled />
                                Kurangi
                            </label>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 md:ml-auto">
                        <label for="input-extra-rows" class="text-xs text-gray-600 ml-2">Jumlah Baris:</label>
                        <input type="number" id="tambahanCount" value="0" min="0"
                            class="w-16 px-2 py-1 border rounded-lg text-xs text-center focus:ring-2 focus:ring-blue-500 transition" />
                    </div>
                    <div class="text-xs text-gray-600">
                        <span id="jumlahData">Jumlah Data : 0</span>
                    </div>
                </div>
                <div id="tabelData" class="overflow-x-auto mt-4"></div>
            </div>
        </main>
    </div>

    <!-- Tombol Kembali -->
    <button onclick="window.location.href='../';"
        class="group fixed top-0 left-0 bg-white hover:bg-gray-100 text-blue-600 p-3 rounded-br-lg shadow-lg z-50 transition duration-300 ease-in-out">
        <svg xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 transform group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
        </svg>
        <span
            class="absolute top-1/2 left-full ml-2 -translate-y-1/2 opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto bg-gray-700 text-white text-xs px-2 py-1 rounded transition-opacity duration-300 whitespace-nowrap">
            Kembali
        </span>
    </button>

    <!-- Tombol Catatan Melayang (Memanggil Modal) -->
    <button onclick="fillNoteForm(); toggleModal();"
        class="group fixed top-0 right-0 bg-white hover:bg-gray-100 text-purple-600 p-3 rounded-bl-lg shadow-lg z-50 transition duration-300 ease-in-out">
        <svg xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 transform group-hover:-translate-y-1 transition-transform" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <path d="M14 2v6h6M14 18H8M16 14H8M16 10H8"></path>
        </svg>
        <span
            class="absolute top-1/2 right-full mr-2 -translate-y-1/2 opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto bg-gray-700 text-white text-xs px-2 py-1 rounded transition-opacity duration-300 whitespace-nowap">
            Catatan
        </span>
    </button>

    <!-- Catatan Modal -->
    <div id="catatanModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[100] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-11/12 md:w-3/4 max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="toggleModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <i class="bi bi-x-circle text-xl"></i>
            </button>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Tambahkan Catatan Baru</h3>
            <!-- Form Catatan -->
            <div class="mt-2 pt-2 border-t border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Keterangan:</label>
                        <input type="text" id="catatanKeterangan" placeholder="Keterangan..."
                            class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" readonly />
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Tanggal Pembayaran:</label>
                        <input type="text" id="catatanTgl" placeholder="Tanggal Pembayaran..."
                            class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" readonly />
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Kategori Bank:</label>
                        <input type="text" id="catatanBank" placeholder="Kategori Bank..."
                            class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" readonly />
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Jenis Transaksi:</label>
                        <input type="text" id="catatanWaktu" placeholder="Jenis Transaksi..."
                            class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" readonly />
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Mode:</label>
                        <input type="text" id="catatanMode" placeholder="Mode..."
                            class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" readonly />
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Jumlah Baris:</label>
                        <input type="text" id="catatanJumlahBaris" placeholder="Jumlah Baris..."
                            class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" readonly />
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-blue-700">Total PBBP2:</label>
                        <input type="text" id="catatanTotalPbb" placeholder="Total PBBP2..."
                            class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" readonly />
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-yellow-700">Pendapatan Denda PBBP2:</label>
                        <input type="text" id="catatanDenda" placeholder="Pendapatan Denda PBBP2..."
                            class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" readonly />
                    </div>
                    <div class="flex flex-col gap-2 md:col-span-2">
                        <label class="text-sm font-medium text-green-700">Total Mutasi Kredit:</label>
                        <input type="text" id="catatanMutasi" placeholder="Total Mutasi Kredit..."
                            class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" readonly />
                    </div>
                    <div class="flex flex-col gap-2 md:col-span-2">
                        <label class="text-sm font-medium text-gray-700">Catatan Tambahan:</label>
                        <textarea id="inputCatatanTambahan" rows="3" placeholder="Tulis catatan tambahan di sini..."
                            class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition"></textarea>
                    </div>
                </div>
                <div class="flex flex-row mt-4 justify-between gap-4">
                    <button id="btnSimpanCatatan"
                        class="bg-purple-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-purple-600 transition flex-1">
                        <i class="bi bi-save"></i> Simpan Catatan
                    </button>
                    <a href="catatan.html" id="btnLihatCatatan" target="_blank"
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition flex-1 text-center">
                        <i class="bi bi-book"></i> Lihat Catatan
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-database.js"></script>

    <script>
        // Your provided Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBWiWtq8Ir-_KPlqSwYEGJkOmM9TTp1pDk",
            authDomain: "rc-notedsbapenda.firebaseapp.com",
            databaseURL: "https://rc-notedsbapenda-default-rtdb.firebaseio.com",
            projectId: "rc-notedsbapenda",
            storageBucket: "rc-notedsbapenda.firebasestorage.app",
            messagingSenderId: "961787045460",
            appId: "1:961787045460:web:1932764db5a4c02f28afc1",
            measurementId: "G-DNC3WPJ7PQ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let allData = [];
        const kategoriBankMap = {
            PBBU: [
                "Bank BJB - Lainnya",
                "Bank BJB - Mobile Banking",
                "Bank BJB - POS",
                "Bank BJB - Teller",
                "Bank BJB - Internet Banking"
            ],
            PBBQRIS: ["Bank BJB - QRIS"],
            PBBVA: ["Bank BJB - Virtual Account"],
            PBBKOLEKTIF: ["Loket Bank BJB - Kolektif"],
            EPBB: [
                "Bank Mandiri - Internet Banking",
                "Bank Mandiri - Teller",
                "Bank Mandiri - POS"
            ]
        };

        // Fungsi untuk mengaktifkan/menonaktifkan modal
        window.toggleModal = function () {
            const modal = document.getElementById("catatanModal");
            modal.classList.toggle("hidden");
        }

        // Fungsi untuk mengisi form catatan di modal dengan data filter saat ini
        window.fillNoteForm = function () {
            const keteranganInput = document.getElementById('inputTeks');
            const tglSelect = document.getElementById('tglSelect');
            const bankSelect = document.getElementById('bankSelect');
            const waktuSelect = document.getElementById('waktuSelect');
            const modeRadio = document.querySelector('input[name="fitur"]:checked');
            const jumlahBarisInput = document.getElementById('tambahanCount');
            const totalPbbText = document.getElementById('totalPbbText');
            const dendaText = document.getElementById('dendaText');
            const mutasiText = document.getElementById('mutasiText');

            const catatanKeterangan = document.getElementById('catatanKeterangan');
            const catatanTgl = document.getElementById('catatanTgl');
            const catatanBank = document.getElementById('catatanBank');
            const catatanWaktu = document.getElementById('catatanWaktu');
            const catatanMode = document.getElementById('catatanMode');
            const catatanJumlahBaris = document.getElementById('catatanJumlahBaris');
            const catatanTotalPbb = document.getElementById('catatanTotalPbb');
            const catatanDenda = document.getElementById('catatanDenda');
            const catatanMutasi = document.getElementById('catatanMutasi');
            const inputCatatanTambahan = document.getElementById('inputCatatanTambahan');

            if (catatanKeterangan && catatanTgl && catatanBank && catatanWaktu && catatanMode && catatanJumlahBaris && catatanTotalPbb && catatanDenda && catatanMutasi && inputCatatanTambahan) {
                let modeText = 'N/A';
                const checkedRadio = document.querySelector('input[name="fitur"]:checked');
                if (checkedRadio) {
                    const parentLabel = checkedRadio.closest('label');
                    if (parentLabel) {
                        modeText = parentLabel.textContent.trim();
                    }
                }

                catatanKeterangan.value = keteranganInput?.value || 'Tidak ada keterangan';
                catatanTgl.value = tglSelect?.value || 'N/A';
                catatanBank.value = bankSelect?.value || 'N/A';
                catatanWaktu.value = waktuSelect?.options[waktuSelect?.selectedIndex]?.text || 'N/A';
                catatanMode.value = modeText;
                catatanJumlahBaris.value = jumlahBarisInput?.value || '0';
                catatanTotalPbb.value = totalPbbText?.textContent || '0';
                catatanDenda.value = dendaText?.textContent || '0';
                catatanMutasi.value = mutasiText?.textContent || '0';
                inputCatatanTambahan.value = '';
            } else {
                console.error("Elemen form catatan tidak ditemukan di modal.");
            }
        }

        document.getElementById("fileExcel").addEventListener("change", function (e) {
            const file = e.target.files[0];
            const label = document.getElementById("uploadLabel");
            const uploadIcon = `<i class="bi bi-upload"></i>`;
            const fileIcon = `<i class="bi bi-file-earmark-excel"></i>`;
            const loadingSpinner = `<div class="spinner"></div>`;

            if (!file) {
                label.innerHTML = `${uploadIcon}<span class="truncate max-w-full">Upload File Excel PBB</span>`;
                return;
            }

            label.innerHTML = `${loadingSpinner}<span class="truncate max-w-full">Memproses...</span>`;

            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, {
                        type: "array"
                    });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        defval: ""
                    });

                    allData = jsonData.map(item => ({
                        pokok: parseFloat(item["POKOK PEMBAYARAN"]) || 0,
                        denda: parseFloat(item["DENDA"]) || 0,
                        total: parseFloat(item["TOTAL"]) || 0,
                        pembayaran: item["BANK"] || "",
                        tglpembayaran: item["TANGGAL PEMBAYARAN"] || ""
                    }));

                    const tanggalMap = {};
                    allData.forEach(item => {
                        const tgl = item.tglpembayaran?.substring(0, 10);
                        if (tgl && /^\d{4}-\d{2}-\d{2}$/.test(tgl)) {
                            if (!tanggalMap[tgl]) tanggalMap[tgl] = 0;
                            tanggalMap[tgl]++;
                        }
                    });

                    const select = document.getElementById("tglSelect");
                    select.innerHTML = `<option value="">Pilih Tanggal Pembayaran</option>`;
                    Object.keys(tanggalMap).sort().forEach(tgl => {
                        const option = document.createElement("option");
                        option.value = tgl;
                        option.textContent = `${tgl} (${tanggalMap[tgl]} data)`;
                        select.appendChild(option);
                    });

                    label.innerHTML = `${fileIcon}<span class="truncate max-w-full">${file.name}</span>`;
                    showToast(`File "${file.name}" berhasil diunggah.`);
                    // Mengaktifkan dropdown bank setelah file diunggah
                    document.getElementById("bankSelect").disabled = false;
                } catch (error) {
                    console.error("Error reading file:", error);
                    label.innerHTML = `${uploadIcon}<span class="truncate max-w-full">Upload File Excel PBB</span>`;
                    showToast("Gagal memuat file. Pastikan formatnya benar.", true);
                }
            };
            reader.onerror = function (error) {
                label.innerHTML = `${uploadIcon}<span class="truncate max-w-full">Upload File Excel PBB</span>`;
                showToast("Terjadi kesalahan saat membaca file.", true);
            };
            reader.readAsArrayBuffer(file);
        });

        // Event listener untuk bankSelect
        document.getElementById("bankSelect").addEventListener("change", () => {
            const tglSelect = document.getElementById("tglSelect");
            const bankSelect = document.getElementById("bankSelect");
            const waktuSelect = document.getElementById("waktuSelect");

            // Reset dan aktifkan dropdown tanggal
            tglSelect.innerHTML = `<option value="">Pilih Tanggal Pembayaran</option>`;
            tglSelect.disabled = false;
            waktuSelect.disabled = false;
            document.querySelectorAll('input[name="fitur"]').forEach(r => r.disabled = false);
            document.getElementById("tambahanCount").disabled = false;

            const selectedKategori = bankSelect.value;
            const datesInKategori = allData
                .filter(item => kategoriBankMap[selectedKategori]?.includes(item.pembayaran))
                .map(item => item.tglpembayaran?.substring(0, 10))
                .filter((v, i, a) => a.indexOf(v) === i && v !== undefined)
                .sort();

            datesInKategori.forEach(date => {
                const option = document.createElement("option");
                option.value = date;
                option.textContent = date;
                tglSelect.appendChild(option);
            });

            // Reset tampilan data
            document.getElementById("tabelData").innerHTML = "";
            document.getElementById("jumlahData").textContent = "Jumlah Data : 0";
            resetSummaryCards();
            tampilkanTabel();
        });

        // Event listener untuk tglSelect
        document.getElementById("tglSelect").addEventListener("change", () => {
            tampilkanTabel();
        });

        // Event listener untuk waktuSelect
        document.getElementById("waktuSelect").addEventListener("change", () => {
            tampilkanTabel();
        });

        document.querySelectorAll('input[name="fitur"]').forEach(radio => {
            radio.addEventListener("change", () => {
                document.getElementById("tambahanCount").value = 0;
                tampilkanTabel();
            });
        });

        document.getElementById("tambahanCount").addEventListener("input", () => {
            tampilkanTabel();
        });

        // Fungsi untuk menyalin teks ke clipboard
        window.copyToClipboard = function (text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            const toast = document.getElementById("toast");
            toast.textContent = `Berhasil menyalin: ${text}`;
            toast.className = `fixed bottom-5 right-5 px-4 py-2 rounded-xl shadow-lg opacity-100 transition-opacity duration-300 z-50 bg-green-500 text-white`;
            setTimeout(() => {
                toast.style.opacity = "0";
            }, 2000);
        }

        // Fungsi untuk menangani paste dari clipboard
        window.pasteFromClipboard = function () {
            const input = document.getElementById("inputTeks");
            input.focus();
            try {
                document.execCommand('paste');
                input.dispatchEvent(new Event('input'));
            } catch (err) {
                alert("Gagal menempel dari clipboard: " + err);
            }
        }

        // Fungsi untuk mereset filter
        document.getElementById("btnReset").addEventListener("click", () => {
            document.getElementById("inputTeks").value = "";
            document.getElementById("tglSelect").value = "";
            document.getElementById("bankSelect").value = "";
            document.getElementById("bankSelect").disabled = true;
            document.getElementById("waktuSelect").value = "semua";
            document.getElementById("waktuSelect").disabled = true;
            document.getElementById("tambahanCount").value = 0;
            document.querySelectorAll('input[name="fitur"]').forEach(r => r.disabled = true);
            document.getElementById("tabelData").innerHTML = "";
            document.getElementById("jumlahData").textContent = "Jumlah Data : 0";
            resetSummaryCards();
        });

        function tampilkanTabel() {
            const selectedDate = document.getElementById("tglSelect").value;
            const selectedKategori = document.getElementById("bankSelect").value;
            const waktuFilter = document.getElementById("waktuSelect").value;
            const fitur = document.querySelector('input[name="fitur"]:checked')?.value;

            if (!selectedDate || !selectedKategori) {
                document.getElementById("tabelData").innerHTML = "";
                document.getElementById("jumlahData").textContent = "Jumlah Data : 0";
                return;
            }

            if (fitur === "versi1") {
                tampilkanTabelVersi1(selectedDate, selectedKategori, waktuFilter);
            } else {
                tampilkanTabelVersi2(selectedDate, selectedKategori, waktuFilter);
            }
        }

        function extractInfo() {
            let text = document.getElementById("inputTeks")?.value?.trim();
            const tglSelect = document.getElementById("tglSelect");
            const bankSelect = document.getElementById("bankSelect");
            const waktuSelect = document.getElementById("waktuSelect");

            if (!text) {
                resetSummaryCards();
                document.getElementById("tabelData").innerHTML = "";
                document.getElementById("jumlahData").textContent = "Jumlah Data : 0";
                document.getElementById("tambahanCount").value = 0;
                tglSelect.value = "";
                bankSelect.value = "";
                bankSelect.disabled = false;
                waktuSelect.value = "semua";
                waktuSelect.disabled = true;
                return;
            }

            let metode = "";
            let tgl = "";
            let waktuFilter = "semua";
            const monthMap = {
                'JANUARI': '01', 'FEBRUARI': '02', 'MARET': '03', 'APRIL': '04', 'MEI': '05', 'JUNI': '06',
                'JULI': '07', 'AGUSTUS': '08', 'SEPTEMBER': '09', 'OKTOBER': '10', 'NOVEMBER': '11', 'DESEMBER': '12'
            };

            const eppbMatch = text.match(/EPBB|E-PBB/i);
            const pbbuMatch = text.match(/PBBU/i);
            const pbbvaMatch = text.match(/PBBVA/i);
            const pbbqrisMatch = text.match(/PBBQRIS/i);
            const pbbkolektifMatch = text.match(/PBBKOLEKTIF/i);

            if (eppbMatch) {
                metode = 'EPBB';
            } else if (pbbuMatch) {
                metode = 'PBBU';
            } else if (pbbvaMatch) {
                metode = 'PBBVA';
            } else if (pbbqrisMatch) {
                metode = 'PBBQRIS';
            } else if (pbbkolektifMatch) {
                metode = 'PBBKOLEKTIF';
            }

            const susulanPelimpahanMatch = text.match(/SUSULAN TGL\s*(\d{8})PELIMPAHAN TGL\s*(\d{8})/i);
            const pelimpahanMatch = text.match(/PELIMPAHAN TGL\s*(\d{8})/i);
            const tglFormatDDMMYYYY = text.match(/TGL\s*(\d{8})/i);

            if (susulanPelimpahanMatch) {
                tgl = formatTgl(susulanPelimpahanMatch[1]);
                waktuFilter = "lebih";
            } else if (pelimpahanMatch && !susulanPelimpahanMatch) {
                tgl = formatTgl(pelimpahanMatch[1]);
                waktuFilter = "kurang";
            } else if (tglFormatDDMMYYYY && !susulanPelimpahanMatch) {
                tgl = formatTgl(tglFormatDDMMYYYY[1]);
                waktuFilter = "kurang";
            } else {
                const dateRangePattern = /(\d{1,2})\s*-\s*(\d{1,2})\s*([A-Za-z]+)\s*(\d{4})/i;
                let matches = text.match(dateRangePattern);
                if (matches) {
                    const startDay = matches[1];
                    const monthText = matches[3].toUpperCase();
                    const year = matches[4];
                    const month = monthMap[monthText];
                    if (startDay && month && year) {
                        tgl = `${year}-${month}-${startDay.padStart(2, '0')}`;
                    }
                }
            }


            const ada = Array.from(tglSelect.options).some(opt => opt.value === tgl);
            if (ada) {
                tglSelect.value = tgl;
            } else {
                console.warn(`Tanggal ${tgl} tidak ditemukan di daftar opsi.`);
            }

            if (["PBBU", "PBBQRIS", "PBBVA", "PBBKOLEKTIF", "EPBB"].includes(metode)) {
                bankSelect.disabled = false;
                bankSelect.value = metode;
                waktuSelect.disabled = false;
                document.querySelectorAll('input[name="fitur"]').forEach(r => r.disabled = false);
                document.getElementById("tambahanCount").disabled = false;

                if (metode === 'EPBB') {
                    waktuSelect.value = "semua";
                } else if (susulanPelimpahanMatch) {
                    waktuSelect.value = "lebih";
                } else if (pelimpahanMatch) {
                    waktuSelect.value = "kurang";
                } else if (tglFormatDDMMYYYY) {
                    waktuSelect.value = "kurang";
                }
            } else {
                bankSelect.disabled = true;
                bankSelect.value = "";
                waktuSelect.disabled = true;
                document.querySelectorAll('input[name="fitur"]').forEach(r => r.disabled = true);
            }

            tampilkanTabel();
        }

        function formatTgl(tglStr) {
            const day = tglStr.substring(0, 2);
            const month = tglStr.substring(2, 4);
            const year = tglStr.substring(4, 8);
            return `${year}-${month}-${day}`;
        }

        function tampilkanTabelVersi1(selectedDate, selectedKategori, waktuFilter) {
            const selectedBankList = kategoriBankMap[selectedKategori] || [];

            const tambahanCount = parseInt(document.getElementById("tambahanCount").value) || 0;

            let filtered = allData.filter(item =>
                item.tglpembayaran &&
                item.tglpembayaran.startsWith(selectedDate) &&
                selectedBankList.includes(item.pembayaran)
            );

            if (waktuFilter !== "semua") {
                filtered = filtered.filter(item => {
                    const timeStr = item.tglpembayaran.split(" ")[1];
                    if (!timeStr) return false;

                    const [jam, menit, detik] = timeStr.split(":").map(Number);
                    const waktuDalamDetik = jam * 3600 + menit * 60 + detik;
                    const batasDetik = 17 * 3600;

                    return waktuFilter === "kurang" ?
                        waktuDalamDetik < batasDetik :
                        waktuDalamDetik >= batasDetik;
                });
            }

            filtered.sort((a, b) => new Date(a.tglpembayaran) - new Date(b.tglpembayaran));

            let finalData;
            if (waktuSelect.value === "lebih") {
                finalData = filtered.slice(Math.min(tambahanCount, filtered.length));
            } else {
                finalData = filtered.slice(0, Math.max(filtered.length - tambahanCount, 0));
            }

            renderTabel(finalData, waktuFilter);
        }

        function tampilkanTabelVersi2(selectedDate, selectedKategori, waktuFilter) {
            const selectedBankList = kategoriBankMap[selectedKategori] || [];

            let filtered = allData.filter(item =>
                item.tglpembayaran &&
                item.tglpembayaran.startsWith(selectedDate) &&
                selectedBankList.includes(item.pembayaran)
            );

            if (waktuFilter !== "semua") {
                filtered = filtered.filter(item => {
                    const timeStr = item.tglpembayaran.split(" ")[1];
                    if (!timeStr) return false;
                    const [jam, menit, detik] = timeStr.split(":").map(Number);
                    const waktuDalamDetik = jam * 3600 + menit * 60 + detik;
                    const batasDetik = 17 * 3600;

                    return waktuFilter === "kurang" ?
                        waktuDalamDetik < batasDetik :
                        waktuDalamDetik >= batasDetik;
                });
            }

            let tambahanData = [];
            const tambahanCount = parseInt(document.getElementById("tambahanCount").value) || 0;

            if (waktuFilter === "kurang") {
                tambahanData = allData.filter(item =>
                    item.tglpembayaran?.startsWith(selectedDate) &&
                    selectedBankList.includes(item.pembayaran)
                ).filter(item => {
                    const timeStr = item.tglpembayaran.split(" ")[1];
                    if (!timeStr) return false;
                    const [jam, menit, detik] = timeStr.split(":").map(Number);
                    const waktuDalamDetik = jam * 3600 + menit * 60 + detik;
                    return waktuDalamDetik >= 17 * 3600;
                }).sort((a, b) => new Date(a.tglpembayaran) - new Date(b.tglpembayaran));
            } else if (waktuFilter === "lebih") {
                tambahanData = allData.filter(item =>
                    item.tglpembayaran?.startsWith(selectedDate) &&
                    selectedBankList.includes(item.pembayaran)
                ).filter(item => {
                    const timeStr = item.tglpembayaran.split(" ")[1];
                    if (!timeStr) return false;
                    const [jam, menit, detik] = timeStr.split(":").map(Number);
                    const waktuDalamDetik = jam * 3600 + menit * 60 + detik;
                    return waktuDalamDetik < 17 * 3600;
                }).sort((a, b) => new Date(b.tglpembayaran) - new Date(a.tglpembayaran));
            }

            const tambahanYangDitampilkan = tambahanData.slice(0, tambahanCount);
            const finalData = [...filtered, ...tambahanYangDitampilkan];

            renderTabel(finalData, waktuFilter);
        }

        function renderTabel(finalData, waktuFilter) {
            finalData.sort((a, b) => {
                const tglA = new Date(a.tglpembayaran);
                const tglB = new Date(b.tglpembayaran);
                return tglA - tglB;
            });

            if (finalData.length > 0) {
                let totalPokok = 0,
                    totalDenda = 0,
                    totalTagihan = 0;
                finalData.forEach(item => {
                    totalPokok += parseFloat(item.pokok) || 0;
                    totalDenda += parseFloat(item.denda) || 0;
                    totalTagihan += parseFloat(item.total) || 0;
                });

                document.getElementById("summaryCards").innerHTML = `
          <div class="bg-blue-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
            <p class="text-sm font-medium text-blue-700 mb-2">Total PBBP2</p>
            <div class="flex items-center justify-between">
              <p id="totalPbbText" class="text-2xl font-bold text-blue-900">${totalPokok.toLocaleString('id-ID')}</p>
              <button onclick="copyToClipboard(document.getElementById('totalPbbText')?.textContent || '0')" class="ml-3 text-blue-500 hover:text-blue-700">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
          </div>
          <div class="bg-yellow-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
            <p class="text-sm font-medium text-yellow-700 mb-2">Pendapatan Denda PBBP2</p>
            <div class="flex items-center justify-between">
              <p id="dendaText" class="text-2xl font-bold text-yellow-900">${totalDenda.toLocaleString('id-ID')}</p>
              <button onclick="copyToClipboard(document.getElementById('dendaText')?.textContent || '0')" class="ml-3 text-yellow-500 hover:text-yellow-700">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
          </div>
          <div class="bg-green-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
            <p class="text-sm font-medium text-green-700 mb-2">Total Mutasi Kredit</p>
            <div class="flex items-center justify-between">
              <p id="mutasiText" class="text-2xl font-bold text-green-900">${totalTagihan.toLocaleString('id-ID')}</p>
              <button onclick="copyToClipboard(document.getElementById('mutasiText')?.textContent || '0')" class="ml-3 text-green-500 hover:text-green-700">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
          </div>
        `;

                let tableHTML = `
        <div id="scrollContainer" class="overflow-auto max-h-[60vh] border border-gray-300 rounded-lg shadow-sm">
          <table id="tableData" class="table-auto w-full border-collapse text-sm">
            <thead class="bg-gray-100 sticky top-0 shadow-md z-10">
              <tr>
                <th class="border-b border-gray-300 p-3 text-right">Pokok</th>
                <th class="border-b border-gray-300 p-3 text-right">Denda</th>
                <th class="border-b border-gray-300 p-3 text-right">Total</th>
                <th class="border-b border-gray-300 p-3 text-left">Bank</th>
                <th class="border-b border-gray-300 p-3 text-left">Tanggal Pembayaran</th>
              </tr>
            </thead>
            <tbody>
        `;

                finalData.forEach((item, index) => {
                    const rowBg = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    tableHTML += `
          <tr class="${rowBg} hover:bg-green-50 transition-colors cursor-default">
            <td class="border-b border-gray-200 p-3 text-right">${(item.pokok || 0).toLocaleString('id-ID')}</td>
            <td class="border-b border-gray-200 p-3 text-right">${(item.denda || 0).toLocaleString('id-ID')}</td>
            <td class="border-b border-gray-200 p-3 text-right">${(item.total || 0).toLocaleString('id-ID')}</td>
            <td class="border-b border-gray-200 p-3 text-left">${item.pembayaran || '-'}</td>
            <td class="border-b border-gray-200 p-3 text-left">${item.tglpembayaran || '-'}</td>
          </tr>
        `;
                });

                tableHTML += `
          </tbody>
        </table>
      </div>
    `;

                document.getElementById("tabelData").innerHTML = tableHTML;
                document.getElementById("jumlahData").textContent = `Jumlah Data : ${finalData.length}`;
            } else {
                document.getElementById("tabelData").innerHTML = `<p class="text-center text-gray-500 mt-4">Data tidak tersedia untuk filter tersebut.</p>`;
                document.getElementById("jumlahData").textContent = "Jumlah Data : 0";
                resetSummaryCards();
            }

            const scrollContainer = document.getElementById("scrollContainer");
            if (waktuFilter === "kurang" && scrollContainer) {
                setTimeout(() => {
                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                }, 100);
            } else if (scrollContainer) {
                scrollContainer.scrollTop = 0;
            }
        }

        function resetSummaryCards() {
            document.getElementById("summaryCards").innerHTML = `
        <div class="bg-blue-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
          <p class="text-sm font-medium text-blue-700 mb-2">Total PBBP2</p>
          <div class="flex items-center justify-between">
            <p id="totalPbbText" class="text-2xl font-bold text-blue-900">0</p>
            <button onclick="copyToClipboard(document.getElementById('totalPbbText')?.textContent || '0')" class="ml-3 text-blue-500 hover:text-blue-700">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
        </div>
        <div class="bg-yellow-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
          <p class="text-sm font-medium text-yellow-700 mb-2">Pendapatan Denda PBBP2</p>
          <div class="flex items-center justify-between">
            <p id="dendaText" class="text-2xl font-bold text-yellow-900">0</p>
            <button onclick="copyToClipboard(document.getElementById('dendaText')?.textContent || '0')" class="ml-3 text-yellow-500 hover:text-yellow-700">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
        </div>
        <div class="bg-green-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
          <p class="text-sm font-medium text-green-700 mb-2">Total Mutasi Kredit</p>
          <div class="flex items-center justify-between">
            <p id="mutasiText" class="text-2xl font-bold text-green-900">0</p>
            <button onclick="copyToClipboard(document.getElementById('mutasiText')?.textContent || '0')" class="ml-3 text-green-500 hover:text-green-700">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
        </div>
      `;
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById("toast");
            if (toast) {
                toast.textContent = message;
                toast.className = `fixed bottom-5 right-5 px-4 py-2 rounded-xl shadow-lg opacity-100 transition-opacity duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`;
                setTimeout(() => {
                    toast.style.opacity = "0";
                }, 3000);
            }
        }

        window.simpanCatatan = function () {
            const keterangan = document.getElementById('catatanKeterangan').value;
            const tanggal = document.getElementById('catatanTgl').value;
            const bank = document.getElementById('catatanBank').value;
            const waktu = document.getElementById('catatanWaktu').value;
            const mode = document.getElementById('catatanMode').value;
            const jumlahBaris = document.getElementById('catatanJumlahBaris').value;
            const catatanTambahan = document.getElementById('inputCatatanTambahan').value;
            const totalPbb = document.getElementById('catatanTotalPbb').value;
            const totalDenda = document.getElementById('catatanDenda').value;
            const totalMutasi = document.getElementById('catatanMutasi').value;

            // Validasi input
            if (keterangan.trim() === '' || keterangan === 'Tidak ada keterangan') {
                showToast("Keterangan catatan tidak boleh kosong.", true);
                return;
            }
            if (tanggal.trim() === '' || tanggal === 'N/A') {
                showToast("Tanggal Pembayaran tidak boleh kosong.", true);
                return;
            }
            if (bank.trim() === '' || bank === 'N/A') {
                showToast("Kategori Bank tidak boleh kosong.", true);
                return;
            }
            if (waktu.trim() === '' || waktu === 'N/A') {
                showToast("Jenis Transaksi tidak boleh kosong.", true);
                return;
            }

            const noteData = {
                keterangan: keterangan,
                tanggal: tanggal,
                bank: bank,
                waktu: waktu,
                mode: mode,
                jumlahBaris: jumlahBaris,
                totalPbb: totalPbb,
                totalDenda: totalDenda,
                totalMutasi: totalMutasi,
                catatanTambahan: catatanTambahan,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            const newNoteRef = database.ref('catatan').push();
            newNoteRef.set(noteData)
                .then(() => {
                    showToast("Catatan berhasil disimpan!");
                    toggleModal(); // Tutup modal setelah disimpan
                })
                .catch(error => {
                    console.error("Gagal menyimpan catatan:", error);
                    showToast("Gagal menyimpan catatan.", true);
                });
        }

        window.ambilCatatan = function () {
            const catatanList = document.getElementById("catatanList");
            const catatanRef = database.ref('catatan').orderByChild('timestamp');

            catatanRef.on('value', (snapshot) => {
                const data = snapshot.val();
                catatanList.innerHTML = '';

                if (data) {
                    const notes = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));

                    notes.forEach(note => {
                        const noteElement = document.createElement('div');
                        noteElement.className = 'bg-gray-100 p-3 rounded-lg text-gray-800 text-sm flex flex-col gap-1 relative';
                        noteElement.innerHTML = `
                            <p class="font-semibold text-gray-900">Keterangan:</p>
                            <p class="mb-2">${note.keterangan || 'Tidak ada keterangan'}</p>
                            <p class="text-xs text-gray-600"><strong>Tanggal:</strong> ${note.tanggal || 'N/A'}</p>
                            <p class="text-xs text-gray-600"><strong>Bank:</strong> ${note.bank || 'N/A'}</p>
                            <p class="text-xs text-gray-600"><strong>Waktu:</strong> ${note.waktu || 'N/A'}</p>
                            <p class="text-xs text-gray-600"><strong>Mode:</strong> ${note.mode || 'N/A'}</p>
                            <p class="text-xs text-gray-600"><strong>Jumlah Baris:</strong> ${note.jumlahBaris || 'N/A'}</p>
                            <p class="text-xs text-gray-600"><strong>Total PBBP2:</strong> ${note.totalPbb || 'N/A'}</p>
                            <p class="text-xs text-gray-600"><strong>Pendapatan Denda PBBP2:</strong> ${note.totalDenda || 'N/A'}</p>
                            <p class="text-xs text-gray-600"><strong>Total Mutasi Kredit:</strong> ${note.totalMutasi || 'N/A'}</p>
                            <p class="text-xs text-gray-600"><strong>Catatan Tambahan:</strong> ${note.catatanTambahan || 'N/A'}</p>
                            <button onclick="hapusCatatan('${note.id}')" class="absolute top-2 right-2 text-red-500 hover:text-red-700">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                        `;
                        catatanList.appendChild(noteElement);
                    });
                } else {
                    catatanList.innerHTML = `<p class="text-sm text-gray-500">Tidak ada catatan.</p>`;
                }
            });
        }

        window.hapusCatatan = function (catatanId) {
            database.ref('catatan/' + catatanId).remove()
                .then(() => {
                    showToast("Catatan berhasil dihapus.");
                })
                .catch(error => {
                    console.error("Gagal menghapus catatan:", error);
                    showToast("Gagal menghapus catatan.", true);
                });
        }

        window.addEventListener("DOMContentLoaded", () => {
             document.getElementById("inputTeks").addEventListener("input", extractInfo);
             document.getElementById("btnSimpanCatatan").addEventListener("click", simpanCatatan);
             ambilCatatan();
         });
    </script>
</body>

</html>