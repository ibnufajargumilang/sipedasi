<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SiRekon PBB | Sistem Rekonsiliasi PBB</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .toast-enter-active,
        .toast-leave-active {
            transition: opacity 0.5s ease;
        }

        .toast-enter-from,
        .toast-leave-to {
            opacity: 0;
        }

        /* Styling untuk loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="min-h-screen p-4">

    <!-- Toast message untuk notifikasi -->
    <div id="toast"
        class="fixed bottom-5 right-5 bg-green-500 text-white px-4 py-2 rounded-xl shadow-lg opacity-0 transition-opacity duration-300 z-50">
    </div>

    <!-- Kontainer utama tanpa batasan lebar, mengisi penuh layar -->
    <div class="flex flex-col md:flex-row w-full min-h-screen bg-white rounded-2xl shadow-xl">
        <!-- Sidebar -->
        <aside
            class="w-full md:w-1/4 max-w-full md:max-w-xs bg-white shadow-lg p-6 flex flex-col gap-4 border-b md:border-b-0 md:border-r border-gray-200 rounded-t-2xl md:rounded-l-2xl md:rounded-tr-none mx-auto md:mx-0">
            <div class="flex items-center gap-3 mb-2 justify-center">
                <i class="bi bi-bank2 text-blue-700 text-2xl"></i>
                <h2 class="text-xl font-bold text-gray-700">Sistem Rekonsiliasi PBB</h2>
            </div>

            <!-- Upload Excel -->
            <div>
                <label for="fileExcel" class="block w-full cursor-pointer">
                    <span id="uploadLabel"
                        class="w-full flex justify-center items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-400 transition overflow-hidden whitespace-nowrap"
                        style="text-align:center;">
                        <i class="bi bi-upload"></i>
                        <span class="truncate max-w-full">
                            Upload File Excel PBB
                        </span>
                    </span>
                </label>
                <input type="file" id="fileExcel" accept=".xlsx, .xls" class="hidden" />
            </div>
            <!-- Dropdown Filters -->
            <div class="flex flex-col gap-4">
                <div class="flex space-x-2 items-center mb-2">
                    <input id="inputTeks" type="text" placeholder="Tempelkan Keterangan Disini"
                        class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition"
                        spellcheck="false" />
                    <button type="button" onclick="pasteFromClipboard()"
                        class="flex items-center gap-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg shadow-md transition"
                        title="Paste"><i class="bi bi-clipboard"></i></button>
                </div>
                <div class="flex items-center gap-2">
                    <i class="bi bi-bank text-lg text-gray-800"></i>
                    <select id="bankSelect"
                        class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" disabled>
                        <option value="">Pilih Kategori Bank</option>
                        <option value="PBBU">PBBU</option>
                        <option value="PBBQRIS">PBBQRIS</option>
                        <option value="PBBVA">PBBVA</option>
                        <option value="PBBKOLEKTIF">PBBKOLEKTIF</option>
                        <option value="EPBB">EPBB</option>
                        <option value="POS">POS</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <i class="bi bi-calendar-date text-lg text-gray-800"></i>
                    <div class="flex flex-col w-full">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 text-sm">
                                <input type="radio" name="tanggalMode" value="single" checked>
                                Satu Tanggal
                            </label>
                            <label class="inline-flex items-center gap-2 text-sm">
                                <input type="radio" name="tanggalMode" value="range">
                                Range
                            </label>
                        </div>
                        <div id="tanggalSingle" class="mt-2">
                            <select id="tglSelect"
                                class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" disabled>
                                <option value="">Pilih Tanggal Pembayaran</option>
                            </select>
                        </div>
                        <div id="tanggalRange" class="hidden mt-2">
                            <label class="text-xs text-gray-600">Dari</label>
                            <input type="date" id="tglStart" class="p-2 rounded-lg border w-full mb-2" disabled />
                            <label class="text-xs text-gray-600">Sampai</label>
                            <div class="flex gap-2">
                                <input type="date" id="tglEnd" class="p-2 rounded-lg border w-full" disabled />
                                <button type="button" id="clearRange"
                                    class="px-3 bg-gray-100 hover:bg-gray-200 rounded-md border border-gray-200" title="Bersihkan range">‚ü≤</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <i class="bi bi-clock text-lg text-gray-800"></i>
                    <select id="waktuSelect"
                        class="p-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-500 transition" disabled>
                        <option value="semua">SEMUA TRANSAKSI</option>
                        <option value="kurang">AKHIR PEMBAYARAN</option>
                        <option value="lebih">TGL PELIMPAHAN</option>
                    </select>
                </div>

                <button id="btnReset"
                    class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-600 transition w-full flex items-center justify-center gap-2">
                    <i class="bi bi-arrow-repeat text-lg"></i>
                    Reset Filter
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="w-full md:w-3/4 px-4 md:px-8 py-6">
            <div id="summaryCards" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-blue-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
                    <p class="text-sm font-medium text-blue-700 mb-2">Total PBBP2</p>
                    <div class="flex items-center justify-between">
                        <p id="totalPbbText" class="text-2xl font-bold text-blue-900">0</p>
                        <button onclick="copyToClipboard(document.getElementById('totalPbbText')?.textContent || '0')"
                            class="ml-3 text-blue-500 hover:text-blue-700">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                <div class="bg-yellow-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
                    <p class="text-sm font-medium text-yellow-700 mb-2">Pendapatan Denda PBBP2</p>
                    <div class="flex items-center justify-between">
                        <p id="dendaText" class="text-2xl font-bold text-yellow-900">0</p>
                        <button onclick="copyToClipboard(document.getElementById('dendaText')?.textContent || '0')"
                            class="ml-3 text-yellow-500 hover:text-yellow-700">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                <div class="bg-green-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
                    <p class="text-sm font-medium text-green-700 mb-2">Total Mutasi Kredit</p>
                    <div class="flex items-center justify-between">
                        <p id="mutasiText" class="text-2xl font-bold text-green-900">0</p>
                        <button onclick="copyToClipboard(document.getElementById('mutasiText')?.textContent || '0')"
                            class="ml-3 text-green-500 hover:text-green-700">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="border rounded-2xl px-4 py-4 bg-white shadow-lg">
                <div class="mb-4 flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <span class="text-gray-600 font-semibold">Mode:</span>
                        <div id="fiturRadioGroup" class="flex gap-4 ml-2">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="radio" name="fitur" value="tambah" checked />
                                Tambah
                            </label>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="radio" name="fitur" value="kurangi" />
                                Kurangi
                            </label>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <label for="tambahanCount" class="text-xs text-gray-600">Jumlah Baris:</label>
                        <input type="number" id="tambahanCount" value="0" min="0"
                            class="w-16 px-2 py-1 border rounded-lg text-xs text-center focus:ring-2 focus:ring-blue-500 transition" />
                        <div class="text-xs text-gray-600 ml-4">
                            <span id="jumlahData">Jumlah Data : 0</span>
                        </div>
                        <!-- Tombol Export Excel -->
                        <button id="exportPbbBtn"
                            class="ml-3 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-md text-sm shadow-sm disabled:opacity-50"
                            disabled>
                            <i class="bi bi-file-earmark-spreadsheet"></i>
                            <span class="ml-2">Export Excel</span>
                        </button>
                    </div>
                </div>
                <div id="tabelData" class="overflow-x-auto mt-4"></div>
            </div>
        </main>
    </div>

    <!-- Tombol Kembali -->
    <button onclick="window.location.href='../';"
        class="group fixed top-0 left-0 bg-white hover:bg-gray-100 text-blue-600 p-3 rounded-br-lg shadow-lg z-50 transition duration-300 ease-in-out">
        <svg xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 transform group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
        </svg>
        <span
            class="absolute top-1/2 left-full ml-2 -translate-y-1/2 opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto bg-gray-700 text-white text-xs px-2 py-1 rounded transition-opacity duration-300 whitespace-nowrap">
            Kembali
        </span>
    </button>

    <script>
        let allData = [];
        const kategoriBankMap = {
            PBBU: [
                "Bank BJB - Lainnya",
                "Bank BJB - Mobile Banking",
                "Bank BJB - POS",
                "Bank BJB - Teller",
                "Bank BJB - Internet Banking",
                "Bank BJB - ATM"
            ],
            PBBQRIS: ["Bank BJB - QRIS"],
            PBBVA: ["Bank BJB - Virtual Account"],
            PBBKOLEKTIF: ["Loket Bank BJB - Kolektif"],
            EPBB: [
                "Bank Mandiri - Internet Banking",
                "Bank Mandiri - Teller",
                "Bank Mandiri - POS"
            ],
            POS: [
                "PT. POS"
            ]
        };

        document.getElementById("fileExcel").addEventListener("change", function (e) {
            const file = e.target.files[0];
            const label = document.getElementById("uploadLabel");
            const uploadIcon = `<i class="bi bi-upload"></i>`;
            const fileIcon = `<i class="bi bi-file-earmark-excel"></i>`;
            const loadingSpinner = `<div class="spinner"></div>`;

            if (!file) {
                label.innerHTML = `${uploadIcon}<span class="truncate max-w-full">Upload File Excel PBB</span>`;
                return;
            }

            label.innerHTML = `${loadingSpinner}<span class="truncate max-w-full">Memproses...</span>`;

            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, {
                        type: "array"
                    });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        defval: ""
                    });

                    allData = jsonData.map(item => ({
                        pokok: parseFloat(item["POKOK PEMBAYARAN"]) || 0,
                        denda: parseFloat(item["DENDA"]) || 0,
                        total: parseFloat(item["TOTAL"]) || 0,
                        pembayaran: item["BANK"] || "",
                        tglpembayaran: item["TANGGAL PEMBAYARAN"] || ""
                    }));

                    const tanggalMap = {};
                    allData.forEach(item => {
                        const tgl = item.tglpembayaran?.substring(0, 10);
                        if (tgl && /^\d{4}-\d{2}-\d{2}$/.test(tgl)) {
                            if (!tanggalMap[tgl]) tanggalMap[tgl] = 0;
                            tanggalMap[tgl]++;
                        }
                    });

                    const select = document.getElementById("tglSelect");
                    select.innerHTML = `<option value="">Pilih Tanggal Pembayaran</option>`;
                    Object.keys(tanggalMap).sort().forEach(tgl => {
                        const option = document.createElement("option");
                        option.value = tgl;
                        option.textContent = `${tgl} (${tanggalMap[tgl]} data)`;
                        select.appendChild(option);
                    });

                    label.innerHTML = `${fileIcon}<span class="truncate max-w-full">${file.name}</span>`;
                    showToast(`File "${file.name}" berhasil diunggah.`);
                    // Mengaktifkan dropdown bank setelah file diunggah
                    document.getElementById("bankSelect").disabled = false;
                } catch (error) {
                    console.error("Error reading file:", error);
                    label.innerHTML = `${uploadIcon}<span class="truncate max-w-full">Upload File Excel PBB</span>`;
                    showToast("Gagal memuat file. Pastikan formatnya benar.", true);
                }
            };
            reader.onerror = function (error) {
                label.innerHTML = `${uploadIcon}<span class="truncate max-w-full">Upload File Excel PBB</span>`;
                showToast("Terjadi kesalahan saat membaca file.", true);
            };
            reader.readAsArrayBuffer(file);
        });

        // Event listener untuk bankSelect
        document.getElementById("bankSelect").addEventListener("change", () => {
            const tglSelect = document.getElementById("tglSelect");
            const bankSelect = document.getElementById("bankSelect");
            const waktuSelect = document.getElementById("waktuSelect");
            const tglStart = document.getElementById('tglStart');
            const tglEnd = document.getElementById('tglEnd');

            // Reset dan aktifkan dropdown tanggal
            tglSelect.innerHTML = `<option value="">Pilih Tanggal Pembayaran</option>`;
            tglSelect.disabled = false;
            waktuSelect.disabled = false;
            document.querySelectorAll('input[name="fitur"]').forEach(r => r.disabled = false);
            document.getElementById("tambahanCount").disabled = false;

            const selectedKategori = bankSelect.value;
            const datesInKategori = allData
                .filter(item => kategoriBankMap[selectedKategori]?.includes(item.pembayaran))
                .map(item => item.tglpembayaran?.substring(0, 10))
                .filter((v, i, a) => a.indexOf(v) === i && v !== undefined)
                .sort();

            datesInKategori.forEach(date => {
                const option = document.createElement("option");
                option.value = date;
                option.textContent = date;
                tglSelect.appendChild(option);
            });

            // setup range inputs (min/max) berdasarkan daftar tanggal jika tersedia
            if (datesInKategori.length && tglStart && tglEnd) {
                const all = datesInKategori.slice().sort();
                tglStart.min = all[0];
                tglStart.max = all[all.length - 1];
                tglEnd.min = all[0];
                tglEnd.max = all[all.length - 1];
                tglStart.disabled = false;
                tglEnd.disabled = false;
            } else {
                if (tglStart) { tglStart.value = ''; tglStart.disabled = true; }
                if (tglEnd) { tglEnd.value = ''; tglEnd.disabled = true; }
            }

            // Reset tampilan data
            document.getElementById("tabelData").innerHTML = "";
            document.getElementById("jumlahData").textContent = "Jumlah Data : 0";
            resetSummaryCards();
            tampilkanTabel();
        });

        // Event listener untuk tglSelect
        document.getElementById("tglSelect").addEventListener("change", tampilkanTabel);
        document.querySelectorAll('input[name="tanggalMode"]').forEach(r => {
            r.addEventListener('change', () => {
                const mode = document.querySelector('input[name="tanggalMode"]:checked').value;
                document.getElementById('tanggalSingle').classList.toggle('hidden', mode !== 'single');
                document.getElementById('tanggalRange').classList.toggle('hidden', mode !== 'range');
                tampilkanTabel();
            });
        });
        document.getElementById('tglStart')?.addEventListener('change', tampilkanTabel);
        document.getElementById('tglEnd')?.addEventListener('change', tampilkanTabel);
        document.getElementById('clearRange')?.addEventListener('click', () => {
            const s = document.getElementById('tglStart');
            const e = document.getElementById('tglEnd');
            if (s) s.value = '';
            if (e) e.value = '';
            // Kembalikan ke single tanggal secara default
            const single = document.querySelector('input[name="tanggalMode"][value="single"]');
            if (single) { single.checked = true; document.getElementById('tanggalSingle').classList.remove('hidden'); document.getElementById('tanggalRange').classList.add('hidden'); }
            tampilkanTabel();
        });

        // Event listener untuk waktuSelect
        document.getElementById("waktuSelect").addEventListener("change", () => {
            tampilkanTabel();
        });

        document.querySelectorAll('input[name="fitur"]').forEach(radio => {
            radio.addEventListener("change", () => {
                document.getElementById("tambahanCount").value = 0;
                tampilkanTabel();
            });
        });

        document.getElementById("tambahanCount").addEventListener("input", () => {
            tampilkanTabel();
        });

        // Fungsi untuk menyalin teks ke clipboard
        window.copyToClipboard = function (text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            const toast = document.getElementById("toast");
            toast.textContent = `Berhasil menyalin: ${text}`;
            toast.className = `fixed bottom-5 right-5 px-4 py-2 rounded-xl shadow-lg opacity-100 transition-opacity duration-300 z-50 bg-green-500 text-white`;
            setTimeout(() => {
                toast.style.opacity = "0";
            }, 2000);
        }

        // Fungsi untuk menangani paste dari clipboard
        window.pasteFromClipboard = function () {
            const input = document.getElementById("inputTeks");
            input.focus();
            try {
                document.execCommand('paste');
                input.dispatchEvent(new Event('input'));
            } catch (err) {
                alert("Gagal menempel dari clipboard: " + err);
            }
        }

        // Fungsi untuk mereset filter
        document.getElementById("btnReset").addEventListener("click", () => {
            document.getElementById("inputTeks").value = "";
            document.getElementById("tglSelect").value = "";
            document.getElementById("bankSelect").value = "";
            document.getElementById("bankSelect").disabled = false;
            document.getElementById("waktuSelect").value = "semua";
            document.getElementById("waktuSelect").disabled = true;
            document.getElementById("tambahanCount").value = 0;
            document.querySelectorAll('input[name="fitur"]').forEach(r => r.disabled = true);
            document.getElementById("tabelData").innerHTML = "";
            document.getElementById("jumlahData").textContent = "Jumlah Data : 0";
            resetSummaryCards();
        });

        function tampilkanTabel() {
            const tanggalMode = document.querySelector('input[name="tanggalMode"]:checked')?.value || 'single';
            const selectedDate = document.getElementById("tglSelect").value;
            const startDate = document.getElementById('tglStart')?.value || '';
            const endDate = document.getElementById('tglEnd')?.value || '';
            const selectedKategori = document.getElementById("bankSelect").value;
            const waktuFilter = document.getElementById("waktuSelect").value;
            const fitur = document.querySelector('input[name="fitur"]:checked')?.value;

            // kategori harus dipilih
            if (!selectedKategori) {
                document.getElementById("tabelData").innerHTML = "";
                document.getElementById("jumlahData").textContent = "Jumlah Data : 0";
                return;
            }

            // kalau mode single, pastikan selectedDate dipilih
            if (tanggalMode === 'single' && !selectedDate) {
                document.getElementById("tabelData").innerHTML = "";
                document.getElementById("jumlahData").textContent = "Jumlah Data : 0";
                return;
            }

            // Jika mode range, pastikan ada minimal satu tanggal (start atau end)
            if (tanggalMode === 'range') {
                if (!startDate && !endDate) {
                    document.getElementById("tabelData").innerHTML = "";
                    document.getElementById("jumlahData").textContent = "Jumlah Data : 0";
                    return;
                }
            }

            if (fitur === "kurangi") {
                tampilkanTabelVersi1(selectedDate, selectedKategori, waktuFilter, startDate, endDate, tanggalMode);
            } else {
                tampilkanTabelVersi2(selectedDate, selectedKategori, waktuFilter, startDate, endDate, tanggalMode);
            }
        }

        function extractInfo() {
            let text = document.getElementById("inputTeks")?.value?.trim();
            const tglSelect = document.getElementById("tglSelect");
            const bankSelect = document.getElementById("bankSelect");
            const waktuSelect = document.getElementById("waktuSelect");

            if (!text) {
                resetSummaryCards();
                document.getElementById("tabelData").innerHTML = "";
                document.getElementById("jumlahData").textContent = "Jumlah Data : 0";
                document.getElementById("tambahanCount").value = 0;
                tglSelect.value = "";
                bankSelect.value = "";
                bankSelect.disabled = false;
                waktuSelect.value = "semua";
                waktuSelect.disabled = true;
                return;
            }

            let metode = "";
            let tgl = "";
            let waktuFilter = "semua";
            const monthMap = {
                'JANUARI': '01', 'FEBRUARI': '02', 'MARET': '03', 'APRIL': '04', 'MEI': '05', 'JUNI': '06',
                'JULI': '07', 'AGUSTUS': '08', 'SEPTEMBER': '09', 'OKTOBER': '10', 'NOVEMBER': '11', 'DESEMBER': '12'
            };

            const eppbMatch = text.match(/EPBB|E-PBB/i);
            const pbbuMatch = text.match(/PBBU/i);
            const pbbvaMatch = text.match(/PBBVA/i);
            const pbbqrisMatch = text.match(/PBBQRIS/i);
            const pbbkolektifMatch = text.match(/PBBKOLEKTIF/i);

            if (eppbMatch) {
                metode = 'EPBB';
            } else if (pbbuMatch) {
                metode = 'PBBU';
            } else if (pbbvaMatch) {
                metode = 'PBBVA';
            } else if (pbbqrisMatch) {
                metode = 'PBBQRIS';
            } else if (pbbkolektifMatch) {
                metode = 'PBBKOLEKTIF';
            }

            const susulanPelimpahanMatch = text.match(/SUSULAN TGL\s*(\d{8})PELIMPAHAN TGL\s*(\d{8})/i);
            const pelimpahanMatch = text.match(/PELIMPAHAN TGL\s*(\d{8})/i);
            const tglFormatDDMMYYYY = text.match(/TGL\s*(\d{8})/i);

            if (susulanPelimpahanMatch) {
                tgl = formatTgl(susulanPelimpahanMatch[1]);
                waktuFilter = "lebih";
            } else if (pelimpahanMatch && !susulanPelimpahanMatch) {
                tgl = formatTgl(pelimpahanMatch[1]);
                waktuFilter = "kurang";
            } else if (tglFormatDDMMYYYY && !susulanPelimpahanMatch) {
                tgl = formatTgl(tglFormatDDMMYYYY[1]);
                waktuFilter = "kurang";
            } else {
                const dateRangePattern = /(\d{1,2})\s*-\s*(\d{1,2})\s*([A-Za-z]+)\s*(\d{4})/i;
                let matches = text.match(dateRangePattern);
                if (matches) {
                    const startDay = matches[1];
                    const monthText = matches[3].toUpperCase();
                    const year = matches[4];
                    const month = monthMap[monthText];
                    if (startDay && month && year) {
                        tgl = `${year}-${month}-${startDay.padStart(2, '0')}`;
                    }
                }
            }


            const ada = Array.from(tglSelect.options).some(opt => opt.value === tgl);
            if (ada) {
                tglSelect.value = tgl;
            } else {
                console.warn(`Tanggal ${tgl} tidak ditemukan di daftar opsi.`);
            }

            if (["PBBU", "PBBQRIS", "PBBVA", "PBBKOLEKTIF", "EPBB"].includes(metode)) {
                bankSelect.disabled = false;
                bankSelect.value = metode;
                waktuSelect.disabled = false;
                document.querySelectorAll('input[name="fitur"]').forEach(r => r.disabled = false);
                document.getElementById("tambahanCount").disabled = false;

                if (metode === 'EPBB') {
                    waktuSelect.value = "semua";
                } else if (susulanPelimpahanMatch) {
                    waktuSelect.value = "lebih";
                } else if (pelimpahanMatch) {
                    waktuSelect.value = "kurang";
                } else if (tglFormatDDMMYYYY) {
                    waktuSelect.value = "kurang";
                }
            } else {
                bankSelect.disabled = true;
                bankSelect.value = "";
                waktuSelect.disabled = true;
                document.querySelectorAll('input[name="fitur"]').forEach(r => r.disabled = true);
            }

            tampilkanTabel();
        }

        function formatTgl(tglStr) {
            const day = tglStr.substring(0, 2);
            const month = tglStr.substring(2, 4);
            const year = tglStr.substring(4, 8);
            return `${year}-${month}-${day}`;
        }

        function tampilkanTabelVersi1(selectedDate, selectedKategori, waktuFilter, startDate = '', endDate = '', tanggalMode = 'single') {
            const selectedBankList = kategoriBankMap[selectedKategori] || [];

            const tambahanCount = parseInt(document.getElementById("tambahanCount").value) || 0;

            let filtered = allData.filter(item => {
                if (!item.tglpembayaran) return false;
                const d = item.tglpembayaran.substring(0, 10);
                const inRange = tanggalMode === 'range' && ((startDate && endDate) ? (d >= startDate && d <= endDate) : (startDate ? d === startDate : (endDate ? d === endDate : false)));
                const matchSingle = tanggalMode === 'single' ? item.tglpembayaran.startsWith(selectedDate) : false;
                return (inRange || matchSingle) && selectedBankList.includes(item.pembayaran);
            });

            if (waktuFilter !== "semua") {
                filtered = filtered.filter(item => {
                    const timeStr = item.tglpembayaran.split(" ")[1];
                    if (!timeStr) return false;

                    const [jam, menit, detik] = timeStr.split(":").map(Number);
                    const waktuDalamDetik = jam * 3600 + menit * 60 + detik;
                    const batasDetik = 17 * 3600;

                    return waktuFilter === "kurang" ?
                        waktuDalamDetik < batasDetik :
                        waktuDalamDetik >= batasDetik;
                });
            }

            filtered.sort((a, b) => new Date(a.tglpembayaran) - new Date(b.tglpembayaran));

            let finalData;
            if (waktuSelect.value === "lebih") {
                finalData = filtered.slice(Math.min(tambahanCount, filtered.length));
            } else {
                finalData = filtered.slice(0, Math.max(filtered.length - tambahanCount, 0));
            }

            renderTabel(finalData, waktuFilter);
        }

        function tampilkanTabelVersi2(selectedDate, selectedKategori, waktuFilter, startDate = '', endDate = '', tanggalMode = 'single') {
            const selectedBankList = kategoriBankMap[selectedKategori] || [];

            // basis: semua record yang sesuai tanggal (single atau range) dan kategori bank
            const base = allData.filter(item => {
                if (!item.tglpembayaran) return false;
                const d = item.tglpembayaran.substring(0, 10);
                const inRange = tanggalMode === 'range' && (
                    (startDate && endDate) ? (d >= startDate && d <= endDate)
                        : (startDate ? d === startDate : (endDate ? d === endDate : false))
                );
                const matchSingle = tanggalMode === 'single' ? item.tglpembayaran.startsWith(selectedDate) : false;
                return (inRange || matchSingle) && selectedBankList.includes(item.pembayaran);
            });

            // filtered = base + tambahan/waktu filter untuk tampil utama
            let filtered = base.slice();
            if (waktuFilter !== "semua") {
                filtered = base.filter(item => {
                    const timeStr = (item.tglpembayaran || "").split(" ")[1];
                    if (!timeStr) return false;
                    const [jam, menit, detik] = timeStr.split(":").map(Number);
                    const waktuDalamDetik = jam * 3600 + menit * 60 + detik;
                    const batasDetik = 17 * 3600;
                    return waktuFilter === "kurang" ? waktuDalamDetik < batasDetik : waktuDalamDetik >= batasDetik;
                });
            }

            // Siapkan data tambahan (dari base, tapi kebalikan waktu) sesuai jumlah
            const tambahanCount = parseInt(document.getElementById("tambahanCount").value) || 0;
            let tambahanData = [];

            if (waktuFilter === "kurang") {
                // tambahkan baris yang waktu >= 17:00:00 (lawan) ‚Äî pilih terurut naik (lebih lama dulu)
                tambahanData = base.filter(item => {
                    const timeStr = (item.tglpembayaran || "").split(" ")[1];
                    if (!timeStr) return false;
                    const [jam, menit, detik] = timeStr.split(":").map(Number);
                    const waktuDalamDetik = jam * 3600 + menit * 60 + detik;
                    return waktuDalamDetik >= 17 * 3600;
                }).sort((a, b) => new Date(a.tglpembayaran) - new Date(b.tglpembayaran));
            } else if (waktuFilter === "lebih") {
                // tambahkan baris yang waktu < 17:00:00 (lawan) ‚Äî pilih terurut turun (terbaru dulu)
                tambahanData = base.filter(item => {
                    const timeStr = (item.tglpembayaran || "").split(" ")[1];
                    if (!timeStr) return false;
                    const [jam, menit, detik] = timeStr.split(":").map(Number);
                    const waktuDalamDetik = jam * 3600 + menit * 60 + detik;
                    return waktuDalamDetik < 17 * 3600;
                }).sort((a, b) => new Date(b.tglpembayaran) - new Date(a.tglpembayaran));
            }

            const tambahanYangDitampilkan = tambahanData.slice(0, tambahanCount);
            const finalData = [...filtered, ...tambahanYangDitampilkan];

            renderTabel(finalData, waktuFilter);
        }

        function renderTabel(finalData, waktuFilter) {
            finalData.sort((a, b) => {
                const tglA = new Date(a.tglpembayaran);
                const tglB = new Date(b.tglpembayaran);
                return tglA - tglB;
            });
            // simpan data untuk export & aktifkan tombol export
            lastFilteredDataPBB = finalData.slice();
            const exportBtn = document.getElementById('exportPbbBtn');
            if (exportBtn) exportBtn.disabled = !(lastFilteredDataPBB && lastFilteredDataPBB.length > 0);

            if (finalData.length > 0) {
                let totalPokok = 0,
                    totalDenda = 0,
                    totalTagihan = 0;
                finalData.forEach(item => {
                    totalPokok += parseFloat(item.pokok) || 0;
                    totalDenda += parseFloat(item.denda) || 0;
                    totalTagihan += parseFloat(item.total) || 0;
                });

                document.getElementById("summaryCards").innerHTML = `
          <div class="bg-blue-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
            <p class="text-sm font-medium text-blue-700 mb-2">Total PBBP2</p>
            <div class="flex items-center justify-between">
              <p id="totalPbbText" class="text-2xl font-bold text-blue-900">${totalPokok.toLocaleString('id-ID')}</p>
              <button onclick="copyToClipboard(document.getElementById('totalPbbText')?.textContent || '0')" class="ml-3 text-blue-500 hover:text-blue-700">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
          </div>
          <div class="bg-yellow-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
            <p class="text-sm font-medium text-yellow-700 mb-2">Pendapatan Denda PBBP2</p>
            <div class="flex items-center justify-between">
              <p id="dendaText" class="text-2xl font-bold text-yellow-900">${totalDenda.toLocaleString('id-ID')}</p>
              <button onclick="copyToClipboard(document.getElementById('dendaText')?.textContent || '0')" class="ml-3 text-yellow-500 hover:text-yellow-700">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
          </div>
          <div class="bg-green-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
            <p class="text-sm font-medium text-green-700 mb-2">Total Mutasi Kredit</p>
            <div class="flex items-center justify-between">
              <p id="mutasiText" class="text-2xl font-bold text-green-900">${totalTagihan.toLocaleString('id-ID')}</p>
              <button onclick="copyToClipboard(document.getElementById('mutasiText')?.textContent || '0')" class="ml-3 text-green-500 hover:text-green-700">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
          </div>
        `;

                let tableHTML = `
        <div id="scrollContainer" class="overflow-auto max-h-[60vh] border border-gray-300 rounded-lg shadow-sm">
          <table id="tableData" class="table-auto w-full border-collapse text-sm">
            <thead class="bg-gray-100 sticky top-0 shadow-md z-10">
              <tr>
                <th class="border-b border-gray-300 p-3 text-right">Pokok</th>
                <th class="border-b border-gray-300 p-3 text-right">Denda</th>
                <th class="border-b border-gray-300 p-3 text-right">Total</th>
                <th class="border-b border-gray-300 p-3 text-left">Bank</th>
                <th class="border-b border-gray-300 p-3 text-left">Tanggal Pembayaran</th>
              </tr>
            </thead>
            <tbody>
        `;

                finalData.forEach((item, index) => {
                    const rowBg = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    tableHTML += `
          <tr class="${rowBg} hover:bg-green-50 transition-colors cursor-default">
            <td class="border-b border-gray-200 p-3 text-right">${(item.pokok || 0).toLocaleString('id-ID')}</td>
            <td class="border-b border-gray-200 p-3 text-right">${(item.denda || 0).toLocaleString('id-ID')}</td>
            <td class="border-b border-gray-200 p-3 text-right">${(item.total || 0).toLocaleString('id-ID')}</td>
            <td class="border-b border-gray-200 p-3 text-left">${item.pembayaran || '-'}</td>
            <td class="border-b border-gray-200 p-3 text-left">${item.tglpembayaran || '-'}</td>
          </tr>
        `;
                });

                tableHTML += `
          </tbody>
        </table>
      </div>
    `;

                document.getElementById("tabelData").innerHTML = tableHTML;
                document.getElementById("jumlahData").textContent = `Jumlah Data : ${finalData.length}`;
            } else {
                document.getElementById("tabelData").innerHTML = `<p class="text-center text-gray-500 mt-4">Data tidak tersedia untuk filter tersebut.</p>`;
                document.getElementById("jumlahData").textContent = "Jumlah Data : 0";
                resetSummaryCards();
                // jika kosong, kosongkan export cache & disable tombol
                lastFilteredDataPBB = [];
                const exportBtn2 = document.getElementById('exportPbbBtn');
                if (exportBtn2) exportBtn2.disabled = true;
            }

            const scrollContainer = document.getElementById("scrollContainer");
            if (waktuFilter === "kurang" && scrollContainer) {
                setTimeout(() => {
                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                }, 100);
            } else if (scrollContainer) {
                scrollContainer.scrollTop = 0;
            }
        }

        function resetSummaryCards() {
            document.getElementById("summaryCards").innerHTML = `
        <div class="bg-blue-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
          <p class="text-sm font-medium text-blue-700 mb-2">Total PBBP2</p>
          <div class="flex items-center justify-between">
            <p id="totalPbbText" class="text-2xl font-bold text-blue-900">0</p>
            <button onclick="copyToClipboard(document.getElementById('totalPbbText')?.textContent || '0')" class="ml-3 text-blue-500 hover:text-blue-700">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
        </div>
        <div class="bg-yellow-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
          <p class="text-sm font-medium text-yellow-700 mb-2">Pendapatan Denda PBBP2</p>
          <div class="flex items-center justify-between">
            <p id="dendaText" class="text-2xl font-bold text-yellow-900">0</p>
            <button onclick="copyToClipboard(document.getElementById('dendaText')?.textContent || '0')" class="ml-3 text-yellow-500 hover:text-yellow-700">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
        </div>
        <div class="bg-green-50 p-6 rounded-2xl shadow-md flex flex-col justify-between">
          <p class="text-sm font-medium text-green-700 mb-2">Total Mutasi Kredit</p>
          <div class="flex items-center justify-between">
            <p id="mutasiText" class="text-2xl font-bold text-green-900">0</p>
            <button onclick="copyToClipboard(document.getElementById('mutasiText')?.textContent || '0')" class="ml-3 text-green-500 hover:text-green-700">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
        </div>
      `;
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById("toast");
            if (toast) {
                toast.textContent = message;
                toast.className = `fixed bottom-5 right-5 px-4 py-2 rounded-xl shadow-lg opacity-100 transition-opacity duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`;
                setTimeout(() => {
                    toast.style.opacity = "0";
                }, 3000);
            }
        }

        // untuk export: simpan data terakhir yang ditampilkan
        let lastFilteredDataPBB = [];

        // fungsi export untuk SiRekonPBB
        function exportPBBToExcel() {
            if (!lastFilteredDataPBB || lastFilteredDataPBB.length === 0) {
                showToast('Tidak ada data untuk diekspor.', true);
                return;
            }

            const rows = lastFilteredDataPBB.map(r => ({
                'Pokok': Number(r.pokok || 0),
                'Denda': Number(r.denda || 0),
                'Total': Number(r.total || 0),
                'Bank': r.pembayaran || '',
                'Tanggal Pembayaran': r.tglpembayaran || ''
            }));

            try {
                const ws = XLSX.utils.json_to_sheet(rows, { skipHeader: false });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'PBB');
                const now = new Date();
                const fname = `SiRekonPBB_Export_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.xlsx`;
                XLSX.writeFile(wb, fname);
                showToast(`Berhasil mengekspor ${rows.length} baris.`);
            } catch (err) {
                console.error('Export PBB error', err);
                showToast('Gagal mengekspor data.', true);
            }
        }

        // hubungkan tombol export
        document.getElementById('exportPbbBtn')?.addEventListener('click', exportPBBToExcel);

        window.addEventListener("DOMContentLoaded", () => {
            document.getElementById("inputTeks").addEventListener("input", extractInfo);
        });
    </script>
</body>

</html>